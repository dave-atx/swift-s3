name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  lint:
    name: SwiftLint
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - name: Install SwiftLint
        run: brew install swiftlint
      - name: Run SwiftLint
        run: swiftlint --strict

  unit-tests-macos:
    name: Unit Tests (macOS)
    needs: lint
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - name: Build
        run: swift build
      - name: Run SwiftS3 Tests
        run: swift test --filter SwiftS3Tests
      - name: Run ss3 Tests
        run: swift test --filter ss3Tests

  unit-tests-linux:
    name: Unit Tests (Linux)
    needs: lint
    runs-on: ubuntu-24.04
    container:
      image: swift:6.2-noble
    steps:
      - uses: actions/checkout@v4
      - name: Build
        run: swift build
      - name: Run SwiftS3 Tests
        run: swift test --filter SwiftS3Tests
      - name: Run ss3 Tests
        run: swift test --filter ss3Tests

  integration-tests-macos:
    name: Integration Tests (macOS)
    needs: lint
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - name: Setup minio
        run: ./Scripts/setup-minio.sh
      - name: Build
        run: swift build
      - name: Run Library Integration Tests
        run: swift test --filter IntegrationTests --no-parallel
      - name: Run CLI Integration Tests
        run: swift test --filter ss3IntegrationTests --no-parallel

  integration-tests-linux:
    name: Integration Tests (Linux)
    needs: lint
    runs-on: ubuntu-24.04
    container:
      image: swift:6.2-noble
    steps:
      - uses: actions/checkout@v4
      - name: Install curl
        run: apt-get update && apt-get install -y curl
      - name: Setup minio
        run: ./Scripts/setup-minio.sh
      - name: Build
        run: swift build
      - name: Run Library Integration Tests
        run: swift test --filter IntegrationTests --no-parallel
      - name: Run CLI Integration Tests
        run: swift test --filter ss3IntegrationTests --no-parallel

  build-macos:
    name: Build macOS
    needs: [unit-tests-macos, unit-tests-linux, integration-tests-macos, integration-tests-linux]
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4

      - name: Generate version file
        run: |
          echo 'let ss3Version = "${{ github.ref_name }}"' > Sources/ss3/Version.generated.swift

      - name: Build arm64
        run: |
          swift build -c release --arch arm64 \
            -Xswiftc -DSS3_VERSION_INJECTED

      - name: Build x86_64
        run: |
          swift build -c release --arch x86_64 \
            -Xswiftc -DSS3_VERSION_INJECTED

      - name: Package arm64
        run: |
          tar -czvf ss3-${{ github.ref_name }}-macos-arm64.tar.gz \
            -C .build/arm64-apple-macosx/release ss3

      - name: Package x86_64
        run: |
          tar -czvf ss3-${{ github.ref_name }}-macos-amd64.tar.gz \
            -C .build/x86_64-apple-macosx/release ss3

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: ss3-*.tar.gz

  build-linux:
    name: Build Linux
    needs: [unit-tests-macos, unit-tests-linux, integration-tests-macos, integration-tests-linux]
    runs-on: ubuntu-24.04
    container:
      image: swift:6.2-noble
    steps:
      - uses: actions/checkout@v4

      - name: Generate version file
        run: |
          echo 'let ss3Version = "${{ github.ref_name }}"' > Sources/ss3/Version.generated.swift

      - name: Install Swift Static Linux SDK
        run: |
          swift sdk install https://download.swift.org/swift-6.2.3-release/static-sdk/swift-6.2.3-RELEASE/swift-6.2.3-RELEASE_static-linux-0.0.1.artifactbundle.tar.gz \
            --checksum f30ec724d824ef43b5546e02ca06a8682dafab4b26a99fbb0e858c347e507a2c

      - name: Install cross-architecture binutils
        run: |
          apt-get update
          apt-get install -y binutils-aarch64-linux-gnu

      - name: Build x86_64
        run: |
          swift build -c release --swift-sdk x86_64-swift-linux-musl \
            -Xswiftc -DSS3_VERSION_INJECTED

      - name: Build arm64
        run: |
          swift build -c release --swift-sdk aarch64-swift-linux-musl \
            -Xswiftc -DSS3_VERSION_INJECTED

      - name: Strip binaries
        run: |
          strip .build/x86_64-swift-linux-musl/release/ss3
          aarch64-linux-gnu-strip .build/aarch64-swift-linux-musl/release/ss3

      - name: Package x86_64
        run: |
          tar -czvf ss3-${{ github.ref_name }}-linux-amd64.tar.gz \
            -C .build/x86_64-swift-linux-musl/release ss3

      - name: Package arm64
        run: |
          tar -czvf ss3-${{ github.ref_name }}-linux-arm64.tar.gz \
            -C .build/aarch64-swift-linux-musl/release ss3

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: ss3-*.tar.gz

  release:
    name: Create Release
    needs: [build-macos, build-linux]
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-binaries

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-binaries

      - name: Generate checksums
        run: sha256sum ss3-*.tar.gz > checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ss3-*.tar.gz
            checksums.txt
          generate_release_notes: true